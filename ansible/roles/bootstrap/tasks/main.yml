---
- name: Get list of installed packages
  ansible.builtin.package_facts:
    manager: auto

- name: Install packages
  ansible.builtin.apt:
    name: "{{ bootstrap_packages }}"
    update_cache: true
    state: present

- name: Setup clients to get time from ntp server
  when: "'ntp' not in group_names"
  block:
    - name: Copy ptp4l-client service configuration
      ansible.builtin.template:
        src: "templates/ptp4l-client.service.j2"
        dest: /etc/systemd/system/ptp4l-client.service
        owner: root
        group: root
        mode: 0755
      notify: reboot

    - name: Enable ptp4l-client service
      ansible.builtin.service:
        name: ptp4l-client
        state: started
        enabled: true

    # https://github.com/jclark/rpi-cm4-ptp-guide/issues/4
    - name: Create override directory for chrony.service
      ansible.builtin.file:
        path: "/etc/systemd/system/chrony.service.d"
        state: directory
        owner: root
        group: root
        mode: 0755

    - name: Copy chrony system configuration to wait for ptp device
      ansible.builtin.template:
        src: "templates/chrony-wantsptp.conf.j2"
        dest: "/etc/systemd/system/chrony.service.d/chrony-wantsptp.conf"
        owner: root
        group: root
        mode: 0644
      notify: reboot

    - name: Copy reflock conf
      ansible.builtin.template:
        src: "templates/refclock.conf.j2"
        dest: /etc/chrony/conf.d/refclock.conf
        owner: root
        group: root
        mode: 0644
      notify: reboot

    - name: Enable chrony service
      ansible.builtin.service:
        name: chrony
        state: restarted
        enabled: true
  
- name: Bootstrap Pis
  ansible.builtin.include_tasks: pi_tasks.yml
  when: "'pi' in group_names"

- name: Bootstrap Tinys
  ansible.builtin.include_tasks: tiny_tasks.yml
  when: "'tiny' in group_names"
