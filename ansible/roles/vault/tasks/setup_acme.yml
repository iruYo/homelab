---
- name: Install acme.sh # noqa: command-instead-of-module
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      curl https://get.acme.sh | sh -s email={{ mail }} --home {{ vault_user_dir }}/.acme.sh
  args:
    chdir: "{{ vault_user_dir }}"
    creates: "{{ vault_user_dir }}/.acme.sh/acme.sh"

- name: Set Let's Encrypt as default CA
  ansible.builtin.lineinfile:
    path: "{{ vault_user_dir }}/.acme.sh/account.conf"
    regexp: '^DEFAULT_ACME_SERVER='
    line: "DEFAULT_ACME_SERVER='https://acme-v02.api.letsencrypt.org/directory'"

- name: Set inital AWS credentials
  when:
    - "vault_inital_aws_access_key is not skipped"
    - "vault_inital_aws_secret_key is not skipped"
  block:
    - name: Set AWS access key
      ansible.builtin.lineinfile:
        path: "{{ vault_user_dir }}/.acme.sh/account.conf"
        regexp: "^SAVED_AWS_ACCESS_KEY_ID="
        line: "SAVED_AWS_ACCESS_KEY_ID='{{ vault_inital_aws_access_key }}'"

    - name: Set AWS secret key
      ansible.builtin.lineinfile:
        path: "{{ vault_user_dir }}/.acme.sh/account.conf"
        regexp: "^SAVED_AWS_SECRET_ACCESS_KEY="
        line: "SAVED_AWS_SECRET_ACCESS_KEY='{{ vault_inital_aws_secret_key }}'"

- name: Issue certificates
  ansible.builtin.command: |
    {{ vault_user_dir }}/.acme.sh/acme.sh
      --issue \
      -d {{ vault_dns }} \
      --dns dns_aws \
      --keylength 2048 \
      --log
  args:
    creates: "{{ vault_user_dir }}/.acme.sh/{{ vault_dns }}/fullchain.cer"

- name: Install certificates into vault tls directory
  ansible.builtin.command: |
    {{ vault_user_dir }}/.acme.sh/acme.sh
      --install-cert \
      -d {{ vault_dns }} \
      --fullchain-file {{ vault_tls_fullchain_crt }} \
      --key-file {{ vault_tls_key_crt }} \
      --reloadcmd "systemctl reload openbao || true"
  args:
    creates: "{{ vault_tls_fullchain_crt }}" # ðŸ¤ž
