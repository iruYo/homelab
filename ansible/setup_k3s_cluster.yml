---
- name: Setup prerequistes for k3s cluster nodes
  hosts: k3s_cluster
  module_defaults:
    ansible.builtin.reboot:
      msg: "Reboot initiated for updates"
      connect_timeout: 5
      reboot_timeout: 300
      pre_reboot_delay: 0
      post_reboot_delay: 30
  gather_facts: true
  become: true
  roles:
    - role: k3s/prerequisites # noqa: role-name[path]

- name: Install k3s master node
  hosts: k3s_master
  gather_facts: true
  become: true
  roles:
    - role: k3s/master # noqa: role-name[path]

- name: Get Kubernets config file
  hosts: k3s_master
  tasks:
    - name: Get k3s config file
      run_once: true
  become: true
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "~/.kube/config"
        flat: true

    - name: Change server address in kubeconfig on control node
      run_once: true
      ansible.builtin.shell: |
        KUBECONFIG=~/.kube/config kubectl config set-cluster default --server=https://{{ k3s_api_vip }}:{{ k3s_api_port }}
      delegate_to: 127.0.0.1
      become: false

#- name: Post-Install k3s master node
#  hosts: k3s_master
#  gather_facts: true
#  become: true
#  roles:
#    - role: k3s/post_master # noqa: role-name[path]

- name: Install k3s agent nodes
  hosts: k3s_agent
  gather_facts: true
  become: true
  roles:
    - role: k3s/agent # noqa: role-name[path]
