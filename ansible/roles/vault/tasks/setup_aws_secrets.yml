---
- name: Show AWS URL for credentials
  ansible.builtin.debug:
    msg: "Generate credentials at\nhttps://us-east-1.console.aws.amazon.com/iam/home?region=eu-central-1#/users"

- name: Get AWS credentials
  vars_prompt:
    - name: aws_access_key
      prompt: AWS Access Key
      private: true
      encrypt: sha512_crypt
      confirm: true
      salt_size: 7


    - name: aws_secret_key
      prompt: AWS Access Key
      private: true
      encrypt: sha512_crypt
      confirm: true
      salt_size: 7

- name: Enable aws secret engine
  community.hashi_vault.vault_write:
    path: "sys/mounts/secrets-aws"

- name: Set inital aws credentials
  community.hashi_vault.vault_write:
    path: secrets-aws/config/root
    data:
      access_key: "{{ aws_access_key }}"
      secret_key: "{{ aws_secret_key }}"
      region: "eu-central-1"

- name: Rotate access
  community.hashi_vault.vault_write:
    path: secrets-aws/config/rotate-root

# external secrets root
# https://gemini.google.com/app/395d5c2b3f65120c
# https://github.com/flux-iac/tofu-controller/tree/main/charts/tofu-controller
# -> tofu manager ensures vault role => auth manager vault auth?
# -> tofu manager ensures policie (arn)

# config lease?
# Tarraform this?
- name: Create cert-manager-role
  community.hashi_vault.vault_write:
    path: secrets-aws/roles/cert-manager
    data:
      credential_type: "{{ aws_access_key }}"
      # policy_arns: [] # Todo
      # policy_document: "@policy-route53.json"
