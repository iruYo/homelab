---
- name: Ensure no swapfile is used
  when: "'dphys-swapfile' in ansible_facts.packages"
  notify: Reboot
  block:
    - name: Disable dphys-swapfile swap
      ansible.builtin.command: dphys-swapfile swapoff
      register: bootstrap_swapoff_output
      changed_when: bootstrap_swapoff_output.rc != 0

    - name: Uninstall dphys-swapfile swap
      ansible.builtin.command: dphys-swapfile uninstall
      register: bootstrap_uninstall_output
      changed_when: bootstrap_uninstall_output.rc != 0

    - name: Remove dphys-swapfile from startup
      ansible.builtin.command: update-rc.d dphys-swapfile remove
      register: bootstrap_remove_output
      changed_when: bootstrap_remove_output.rc != 0

    - name: Purge dphys-swapfile package
      ansible.builtin.apt:
        name: dphys-swapfile
        state: absent
        purge: true
        autoclean: true
        autoremove: true

- name: Enable cgroup in config.txt
  ansible.builtin.lineinfile:
    path: /boot/firmware/cmdline.txt
    backrefs: true
    regexp: '^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$'
    line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
  notify: Reboot

- name: Add explicit fan curve to config.txt
  ansible.builtin.lineinfile:
    path: /boot/firmware/config.txt
    regexp: '^dtparam={{ item.key }}='
    line: 'dtparam={{ item.key }}={{ item.value }}'
  loop: "{{ bootstrap_pi_fan_curve }}"
  notify: Reboot
