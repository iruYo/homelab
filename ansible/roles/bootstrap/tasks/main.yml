---
- name: Install packages
  ansible.builtin.apt:
    name: "{{ bootstrap_packages }}"
    update_cache: true
    state: present

- name: Setup clients to get time from ntp server
  when: "'ntp' not in group_names"
  block:
    - name: Install ntp packages
      ansible.builtin.apt:
        name: "{{ bootstrap_ntp_packages }}"
        update_cache: true
        state: present

    - name: Fetch used ptp clock from ethtool
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -o pipefail
          ethtool -T {{ iface }} | sed -nr "s/^PTP Hardware Clock:[[:space:]](.+)/\1/p"
      register: bootstrap_clock_check_result
      changed_when: false

    - name: Set ptp clock
      ansible.builtin.set_fact:
        bootstrap_ptp_clock: "ptp{{ bootstrap_clock_check_result.stdout }}"

    - name: Copy ptp4l-client configuration
      ansible.builtin.copy:
        src: "ptp4l-client.conf"
        dest: /etc/ptp4l-client.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart ptp4l-client

    - name: Copy ptp4l-client service configuration
      ansible.builtin.template:
        src: "templates/ptp4l-client.service.j2"
        dest: /etc/systemd/system/ptp4l-client.service
        owner: root
        group: root
        mode: "0755"
      notify: Restart ptp4l-client

    - name: Ensure ptp4l-client service
      ansible.builtin.service:
        name: ptp4l-client
        state: started
        enabled: true

    # https://github.com/jclark/rpi-cm4-ptp-guide/issues/4
    - name: Ensure override directory for chrony.service exists
      ansible.builtin.file:
        path: "/etc/systemd/system/chrony.service.d"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy chrony system configuration to wait for ptp device
      ansible.builtin.template:
        src: "templates/chrony-wantsptp.conf.j2"
        dest: "/etc/systemd/system/chrony.service.d/chrony-wantsptp.conf"
        owner: root
        group: root
        mode: "0644"
      notify: Restart chrony

    - name: Copy reflock conf
      ansible.builtin.template:
        src: "templates/refclock.conf.j2"
        dest: /etc/chrony/conf.d/refclock.conf
        owner: root
        group: root
        mode: "0644"
      notify: Restart chrony

    - name: Ensure chrony service
      ansible.builtin.systemd:
        name: chrony
        state: started
        enabled: true
        daemon_reload: true

- name: Set local DNS servers
  ansible.builtin.set_fact:
    bootstrap_dns_servers: "{{ bootstrap_dns_servers | default([]) + [hostvars[item]['ansible_host']] }}"
  loop: "{{ groups['dns'] }}"
  loop_control:
    index_var: i
    break_when: i == 2
  run_once: true

# - name: Add local DNS server
# Done in host specific tasks - assuming RPis always use Networkmanager
# and everything else dhcpcd

- name: Bootstrap Pis
  ansible.builtin.include_tasks: pi_tasks.yml
  when: "'pi' in group_names"

- name: Bootstrap Tinys
  ansible.builtin.include_tasks: tiny_tasks.yml
  when: "'tiny' in group_names"

- name: Ensure changes stick for future roles
  ansible.builtin.meta: flush_handlers
