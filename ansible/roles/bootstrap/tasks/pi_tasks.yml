---
- name: Ensure no swapfile is used
  when: "'dphys-swapfile' in ansible_facts.packages"
  notify: Reboot
  block:
    - name: Disable dphys-swapfile swap
      ansible.builtin.command: dphys-swapfile swapoff
      register: bootstrap_swapoff_output
      changed_when: bootstrap_swapoff_output.rc != 0

    - name: Uninstall dphys-swapfile swap
      ansible.builtin.command: dphys-swapfile uninstall
      register: bootstrap_uninstall_output
      changed_when: bootstrap_uninstall_output.rc != 0

    - name: Remove dphys-swapfile from startup
      ansible.builtin.command: update-rc.d dphys-swapfile remove
      register: bootstrap_remove_output
      changed_when: bootstrap_remove_output.rc != 0

    - name: Purge dphys-swapfile package
      ansible.builtin.apt:
        name: dphys-swapfile
        state: absent
        purge: true
        autoclean: true
        autoremove: true

- name: Enable cgroup in config.txt
  ansible.builtin.lineinfile:
    path: /boot/firmware/cmdline.txt
    backrefs: true
    regexp: '^((?!.*\bcgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory\b).*)$'
    line: '\1 cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory'
  notify: Reboot

- name: Add explicit fan curve to config.txt
  ansible.builtin.lineinfile:
    path: /boot/firmware/config.txt
    regexp: '^dtparam={{ item.key }}='
    line: 'dtparam={{ item.key }}={{ item.value }}'
    insertafter: '^\[all\]'
  loop: "{{ bootstrap_pi_fan_curve }}"
  notify: Reboot

- name: Determine if host is a Raspberry Pi 5
  ansible.builtin.command: grep -q "Raspberry Pi 5" /proc/cpuinfo
  register: bootstrap_pi5_check
  changed_when: false
  failed_when: false

- name: Set fact if Raspberry Pi 5 detected
  ansible.builtin.set_fact:
    bootstrap_is_pi5: "{{ bootstrap_pi5_check.rc == 0 }}"
  when: bootstrap_pi5_check.rc is defined

- name: Overvoltage Raspberry Pi 5 for SSD compatability
  when: bootstrap_is_pi5
  ansible.builtin.blockinfile:
    path: /boot/firmware/config.txt
    block: |
      [board-type=0x17]
      over_voltage_delta=50000
      arm_freq=2500
  notify: Reboot

- name: Enable PCIe Gen 3 for Raspberry Pi 5
  when: bootstrap_is_pi5
  ansible.builtin.blockinfile:
    path: /boot/firmware/config.txt
    block: |
      dtparam=pciex1
      dtparam=pciex1_gen=3
    insertafter: '^\[all\]'
  notify: Reboot
