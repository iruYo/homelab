---
- name: Copy gpg key for vault key encryption
  ansible.builtin.copy:
    src: pub.asc
    dest: /tmp/pub.asc
    owner: root
    group: root
    mode: "0644"

- name: Start vault initialization
  ansible.builtin.command: |
    bao operator init \
      -recovery-shares=3 \
      -recovery-threshold=2 \
      -recovery-pgp-keys="/tmp/pub.asc,/tmp/pub.asc,/tmp/pub.asc"
  register: vault_init
  no_log: true
  changed_when: false

- name: Set recovery keys and initial root token
  ansible.builtin.set_fact:
    vault_root_token: "{{ (vault_init.stdout | regex_findall('Initial Root Token:\\s*(\\S+)', multiline=True) | first) }}"
    vault_recovery_keys: "{{ vault_init.stdout | regex_findall('Recovery Key \\d+:\\s*(\\S+)', multiline=True) }}"
  no_log: true

- name: Write keys to to local file
  delegate_to: localhost
  run_once: true
  ansible.builtin.copy:
    dest: "{{ inventory_dir }}/vault"
    content: |
      root_token: {{ vault_root_token }}
      recovery_keys:
      {% for key in vault_recovery_keys %}
        - {{ key }}
      {% endfor %}
    mode: "0600"
  no_log: true

- name: Remove gpg key
  ansible.builtin.file:
    path: /tmp/pub.asc
    state: absent

- name: Setup auths and engines
  module_defaults:
    group/community.hashi_vault.vault:
      token: "{{ vault_root_token }}"
  block:
    - name: Enable kv2 secret engine
      community.hashi_vault.vault_write:
        path: "sys/mounts/secret"
        data:
          type: "kv"
          options:
            version: "2"

    - name: Enable approle authentication
      community.hashi_vault.vault_write:
        path: "sys/auth/approle"
        data:
          type: "approle"

- name: Setup admin AppRole authentication
  module_defaults:
    group/community.hashi_vault.vault:
      token: "{{ vault_root_token }}"
  block:
    - ansible.builtin.include_tasks: setup_admin_approle.yml # noqa: name[missing]

- name: Setup ansible AppRole authentication
  module_defaults:
    group/community.hashi_vault.vault:
      token: "{{ vault_root_token }}"
  block:
    - ansible.builtin.include_tasks: setup_ansible_approle.yml # noqa: name[missing]

#- name: Revoke root Token
#  community.hashi_vault.vault_write:
#    token: "{{ vault_root_token }}"
#    path: "auth/token/revoke-self"
